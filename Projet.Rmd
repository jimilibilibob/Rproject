---
title: "Projet R - Cours Outils et Méthodologie"
author: "Thomas FONTAINE, Dan GOLDMAN, Juliette LEMAINS, Nicolas ROBIN"
date: "02/01/2019"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=TRUE, warning=FALSE, message=FALSE)
```


**Objectif du projet :**

* Manipuler et analyser de la Data sous R.

* Programmer en R

* Sortir un rapport en utilisant R-Markdown


**Contexte :**
Une société X a envoyé ses données clients ainsi que ses achats sur l'année N-2 (2016) et N-1 (2017).
Le but est de sortir un rapport d’étude 

**Durée :**
Rapport et programme à retourner pour le 13 janvier 2019 au plus tard.

**Les données :**
Les tables mises à disposition sont structurées de la manière suivante :

![](structure.png)

# Enoncé

# 1 - Etude globale

## 1.1	Répartition Adhérant / VIP ....

**Constituer un camembert suivant la répartition suivante :**

*	*VIP* : client étant VIP (VIP = 1)

*	*NEW_N2* : client ayant adhéré au cours de l'année N-2 (date début adhésion)

*	*NEW_N1* : client ayant adhéré au cours de l'année N-1 (date début adhésion)

*	*ADHERANT* : client toujours en cours d'adhésion (date de fin d'adhésion > 2018/01/01)

*	*CHURNER* : client ayant churner (date de fin d'adhésion < 2018/01/01)


*Note : le critère le plus au-dessus est prioritaire, exemple : un client étant VIP, et ayant adhéré sur l'année N-1 sera compté comme étant VIP*

## 1.2	Comportement du CA GLOBAL par client N-2 vs N-1

Constituer une boite à moustache pour chaque année (N-2 et N-1) comparant le CA TOTAL (TTC) des clients (sommer les achats par client par années)

## 1.3	Répartition par age x sexe

Constituer un graphique montrant la répartition par age x sexe sur l'ensemble des clients.
		

# 2 -	Etude par magasin

## 2.1	Résultat par magasin (+ 1 ligne Total)

Constituer un tableau (formattable) reprenant les données suivantes :

* *MAGASIN*

* *NOMBRE DE CLIENTS RATTACHES AU MAGASIN* (avec une color_bar en fonction de la quantité)

* *NOMBRE DE CLIENTS ACTIFS sur N-2*

* *NOMBRE DE CLIENTS ACTIFS sur N-1*

* *% CLIENT N-2 vs N-1* (couleur police : vert si positif, rouge si négatif)

* *TOTAL_TTC N-2*

* *TOTAL_TTC N-1*

* *Différence entre N-2 et N-1* (couleur police : vert si positif, rouge si négatif)

* *Indice évolution *(icône de satisfaction : positif si le pourcentage de clients actifs évolue et total TTC aussi, négatif si il y a une diminution des 2 indicateurs, moyen si seulement l'un des deux diminue)

*Note --> on effectuera un tri sur l'indice d'évolution : les positifs en haut, les négatifs en bas.*

## 2.2	Distance CLIENT <-> MAGASIN

L'objectif est de calculer la distance qui existe entre le magasin et le client.

Les informations disponibles sont :

*	*la ville du magasin*

*	*le code INSEE du client*

Il faut télécharger les données GPS des villes et code-insee pour pouvoir calculer la distance :\
https://public.opendatasoft.com/explore/dataset/correspondance-code-insee-code-postal

Une fois les données acquises, il faut :

* lier les données GPS composé de la latitude et de la longitude au client et au magasin.

* constituer pour chaque client et chaque magasin 2 colonnes : latitude et longitude.

* créer une fonction qui détermine la distance entre 2 points.

La fonction doit prendre 4 variable en compte : latitude1, longitude1, latitude2, longitude2.\
Pour savoir si la fonction est correcte : http://www.lexilogos.com/calcul_distances.htm

Constituer une représentation (tableau ou graphique --> au choix) représentant le nombre de client par distance :

* *0 à 5km*

* *5 à 10km*

* *10 à 20km*

* *20 à 50km*

* *plus de 50km*

# 3 - Etude par univers

## 3.1 Evolution du CA par univers

Constituer un histogramme N-2 / N-1 affichant l'évolution du CA par univers

## 3.2	Top par univers

Afficher le top 5 des familles les plus rentable par univers (en fonction de la marge obtenu) (tableau ou graphique -> au choix)


# Programmation R

### 1. Mise en place de l'environnement de travail

Chargement du fichier paramètres qui permet :

* le chargement des biliothèques nécessaires à l'éxecutuon des scripts R de ce fichier.

* le chargement des variables des fichiers.

* le chargement des tables.

# 1 - Etude globale

Nous importons ici les différents paramètres (bases de données, variables, etc.) et les fonctions permettant de répondres aux problématiques.

```{r}
source("Parametres.R")
```

```{r}
source("Projet.R")
```

## 1.1	Répartition Adhérant / VIP ....
La fonction qui suit permet de générer un camembert représentant la répartition des clients VIP, adhérants au cours de N-1, adhérant au cours de N-2 et les churner. Il a bien entendu fallu, dans la définition de la fonction, gérer les clients qui appartiennent à deux ensembles.

```{r}
repartition_adherant_vip_1.1(ANNEE_EN_COURS,convert_date_client(clients))
```

## 1.2	Comportement du CA GLOBAL par client N-2 vs N-1
Cette fonction représente deux boites à moustache représentants les CA par clients sur l'année N-1 et N-2. Lors de la définition de cette fonction, il a fallu exclure les valeurs abérrantes qui biaisaient énormément la répartition.
```{r}
comportement_CA_1.2(ANNEE_EN_COURS,entetes)
```

## 1.3	Répartition par age x sexe
INTRO 1.3
```{r}
proportion_sexe_age_1.3(clients)
```

# 2 -	Etude par magasin

## 2.1	Résultat par magasin (+ 1 ligne Total)
INTRO 2.1
```{r}
resultat_magasin_2.1(ANNEE_EN_COURS,clients, magasins, entetes)
```

## 2.2	Distance CLIENT <-> MAGASIN
INTRO 2.2
```{r}
distance_Client_Magasin_2.2(insee, magasins, clients)
```

# 3 - Etude par univers

## 3.1 Evolution du CA par univers
INTRO 3.1
```{r}
etude_par_univers_3.1(articles,lignes,entetes)
```

## 3.2	Top 5 des familles les plus rentable par univers
INTRO 3.2
```{r}
top_par_univers_3.2(articles,lignes)
```
